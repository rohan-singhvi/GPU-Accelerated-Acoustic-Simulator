cmake_minimum_required(VERSION 3.18)
project(AcousticSimulator LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CUDA_STANDARD 17)

find_package(OpenMP) 
if(OpenMP_CXX_FOUND)
    link_libraries(OpenMP::OpenMP_CXX)
endif()

find_package(PkgConfig QUIET)
if(PKG_CONFIG_FOUND)
    pkg_check_modules(FFTW3 fftw3f) 
endif()

include(CheckLanguage)
check_language(CUDA)

set(GPU_HARDWARE_AVAILABLE OFF)
find_program(NVIDIA_SMI "nvidia-smi")
if(NVIDIA_SMI)
    execute_process(COMMAND ${NVIDIA_SMI} -L 
        RESULT_VARIABLE SMI_RET 
        OUTPUT_QUIET ERROR_QUIET)
    if(SMI_RET EQUAL 0)
        set(GPU_HARDWARE_AVAILABLE ON)
    endif()
endif()

if(CMAKE_CUDA_COMPILER AND GPU_HARDWARE_AVAILABLE)
    enable_language(CUDA)
    find_package(CUDAToolkit REQUIRED)
    
    if(NOT DEFINED CMAKE_CUDA_ARCHITECTURES)
        set(CMAKE_CUDA_ARCHITECTURES "native")
    endif()

    set(ENABLE_CUDA ON)
    message(STATUS "CUDA Found & GPU Hardware Detected! Building Hybrid GPU/CPU version.")
else()
    set(ENABLE_CUDA OFF)
    if(CMAKE_CUDA_COMPILER)
        message(STATUS "NVCC found, but GPU hardware check failed (e.g. Mac/CPU Host). Disabling CUDA.")
    else()
        message(STATUS "CUDA NOT Found. Building CPU-only version.")
    endif()
    
    if(NOT FFTW3_FOUND)
        message(WARNING "FFTW3 not found. CPU Convolution will be slow.")
    endif()
endif()

# --- Sources ---
# Update paths to reflect new structure
set(SOURCES 
    src/main.cpp 
    src/cpu/simulation_cpu.cpp 
    src/cpu/convolution_cpu.cpp
)

if(ENABLE_CUDA)
    list(APPEND SOURCES 
        src/gpu/simulation_gpu.cu 
        src/gpu/convolution_gpu.cu
    )
endif()

add_executable(acoustic_sim ${SOURCES})

# --- Compile Definitions ---
if(ENABLE_CUDA)
    target_compile_definitions(acoustic_sim PRIVATE ENABLE_CUDA=1)
    target_link_libraries(acoustic_sim PRIVATE CUDA::cufft CUDA::cudart)

    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        target_compile_options(acoustic_sim PRIVATE $<$<COMPILE_LANGUAGE:CUDA>:-O3 --use_fast_math>)
    endif()
endif()

target_include_directories(acoustic_sim PRIVATE include src/gpu)

if(FFTW3_FOUND)
    target_include_directories(acoustic_sim PRIVATE ${FFTW3_INCLUDE_DIRS})
    target_link_libraries(acoustic_sim PRIVATE ${FFTW3_LIBRARIES})
    target_compile_definitions(acoustic_sim PRIVATE USE_FFTW)
endif()


find_program(CLANG_FORMAT "clang-format")
if(CLANG_FORMAT)
    # Find all C++, Header, and CUDA files in src and include
    file(GLOB_RECURSE ALL_SOURCE_FILES 
        "src/*.cpp" 
        "src/*.h" 
        "src/*.cu" 
        "src/*.cuh" 
        "include/*.h"
    )

    add_custom_target(format
        COMMAND ${CLANG_FORMAT} -i -style=file ${ALL_SOURCE_FILES}
        COMMENT "Auto-formatting all source code..."
        VERBATIM
    )
    message(STATUS "Added 'make format' target")
else()
    message(WARNING "clang-format not found. 'make format' will not be available.")
endif()